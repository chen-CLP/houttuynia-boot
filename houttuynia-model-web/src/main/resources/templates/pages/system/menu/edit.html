<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <head th:include="include::header"></head>
    <link rel="stylesheet" type="text/css" href="/static/css/add-style.css">
</head>
<body>
<div class="container-scroller">
    <form class="sample-form" id="parentForm">
        <div class="sample-form-content">
            <div class="form-row">
                <div class="form-group-a row-item">
                    <label class="col-form-label">父级目录：</label>
                    <div class="col-sm-input">
                        <input type="text" class="form-input-text form-input-single" id="parentName" name="parentName"
                               th:value="${menuDetails.parentName}" readonly/>
                        <input id="parentId" name="parentId" th:value="${menuDetails.parentId}" hidden/>
                    </div>
                </div>
                <div class=" form-group-a row-item">
                    <label class="col-form-label">菜单名称：</label>
                    <div class="col-sm-input">
                        <input type="text" class="form-input-text " id="menuName" name="menuName"
                               th:value="${menuDetails.menuName}"/>
                        <input id="id" name="id" th:value="${menuDetails.id}" hidden/>

                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group-a row-item">
                    <label class="col-form-label">链接地址：</label>
                    <div class="col-sm-input">
                        <input type="text" class="form-input-text " id="menuUrl" name="menuUrl"
                               th:value="${menuDetails.menuUrl}" style="width: 65%"/>
                        <i class="layui-icon layui-icon-search" style="cursor: pointer; margin: 13px 0 0 15px"
                           onclick="openApiModel('menuUrl')"></i>
                    </div>
                </div>
                <div class="form-group-a row-item">
                    <label class="col-form-label">菜单类型：</label>
                    <div class="col-sm-input" style="width: 150px">
                        <div class="layui-form">
                            <div class="layui-form-item">
                                <input type="radio" name="menuType" value="link" title="链接页面"
                                       lay-filter="menu-radio-filter" checked>
                                <input type="radio" name="menuType" value="dynamic" title="动态页面"
                                       lay-filter="menu-radio-filter">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group-a row-item">
                    <label class="col-form-label">顺序：</label>
                    <div class="col-sm-input" style="width: 100px">
                        <input type="number" class="form-input-text " id="menuNum" name="menuNum" min="0"
                               th:value="${menuDetails.menuNum}"
                               style="width: 100%"/>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group-a row-item">
                    <label class="col-form-label">图标：</label>
                    <div class="col-sm-input">
                        <input type="text" class="form-input-text " id="menuIcon" name="menuIcon"
                               th:value="${menuDetails.menuIcon}" style="width:65%"/>
                        <i id="ico-btn" class="layui-icon layui-icon-search" onclick="openIconsHtml('menuIcon')"
                           style="cursor: pointer; margin: 13px 0 0 15px"></i>
                    </div>
                </div>
                <div class="form-group-a row-item">
                    <label class="col-form-label">打开方式：</label>
                    <div class="col-sm-input">
                        <div class="layui-form">
                            <input type="radio" name="openType" value="1" title="内部IFrame"
                                   th:checked="${menuDetails.openType eq 1}">
                            <input type="radio" name="openType" value="2" title="新窗口"
                                   th:checked="${menuDetails.openType eq 2}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="layui-tab " lay-filter="test-hash">
                    <ul class="layui-tab-title">
                        <li class="layui-this" lay-id="11">列表配置</li>
                        <li lay-id="22">查询配置</li>
                        <li lay-id="33">按钮配置</li>
                    </ul>
                    <div class="layui-tab-content">
                        <div class="layui-tab-item layui-show">
                            <div class="tab-item-butt">
                                <button type="button" class="layui-btn layui-btn-normal" onclick="handleAddRow1()">
                                    <i class="layui-icon layui-icon-add-1"></i>
                                    新增
                                </button>
                            </div>
                            <div class="tab-item-content">
                                <div class="tab-item-content-header">
                                    <div class="tab-row">
                                        <div class="tab-tr" style="width: 140px">
                                            <span>排序</span>
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <span>字段</span>
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <span>字段名称</span>
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <span>字段备注</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-item-content-val" id="content1">
                                </div>
                            </div>
                        </div>

                        <div class="layui-tab-item">
                            <div class="tab-item-butt">
                                <button type="button" class="layui-btn layui-btn-normal" onclick="handleAddRow2()">
                                    <i class="layui-icon layui-icon-add-1"></i>
                                    新增
                                </button>
                            </div>
                            <div class="tab-item-content">
                                <div class="tab-item-content-header">
                                    <div class="tab-row">
                                        <div class="tab-tr" style="width: 140px">
                                            <span>字段名称</span>
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <span>字段备注</span>
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <span>控件类型</span>
                                        </div>
                                        <div class="tab-tr" style="width: 100px">
                                            <span>字典Code</span>
                                        </div>
                                        <div class="tab-tr" style="width: 100px">
                                            <span>默认值</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-item-content-val" id="content2">
                                </div>
                            </div>
                        </div>

                        <div class="layui-tab-item">
                            <div class="tab-item-butt">
                                <button type="button" class="layui-btn layui-btn-normal" onclick="handleAddRow3()">
                                    <i class="layui-icon layui-icon-add-1"></i>
                                    新增
                                </button>
                            </div>
                            <div class="tab-item-content">
                                <div class="tab-item-content-header">
                                    <div class="tab-row">
                                        <div class="tab-tr" style="width: 140px">
                                            <span>按钮名称</span>
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <span>URL</span>
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <span>查询类型</span>
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <span>参数字段</span>
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <span>图标</span>
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <span>提示信息</span>
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <span>是否加入权限</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-item-content-val" id="content3">
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
        <div class="layui-input-block local-center">
            <button type="button" class="layui-btn" onclick="saveData()">立即提交</button>
        </div>
    </form>
</div>

<div th:include="include::footerJs"></div>
<script th:inline="javascript">
    const menuDetails = [[${menuDetails}]];
    let formId1 = 0, formId2 = 0, formId3 = 0;
    let fieldConf = JSON.parse(menuDetails.fieldConf);
    let queryConf = JSON.parse(menuDetails.queryConf);
    let buttonConf = JSON.parse(menuDetails.buttonConf);

    $(function () {
        layui.use(function () {
            let element = layui.element;
            // hash 地址定位
            let hashName = 'tabid'; // hash 名称
            let layid = location.hash.replace(new RegExp('^#' + hashName + '='), ''); // 获取 lay-id 值
            // 初始切换
            element.tabChange('test-hash', layid);
            // 切换事件
            element.on('tab(test-hash)', function (obj) {
                location.hash = hashName + '=' + this.getAttribute('lay-id');
            });

            layui.form.on('radio(menu-radio-filter)', function (data) {
                let value = data.value;
                if (value === "dynamic") {
                    $("#dynamic-conf")[0].style.display = 'flex';
                } else {
                    $("#dynamic-conf")[0].style.display = 'none';
                }
            });

        });
        fieldConf.forEach(handleAddRow1);
        queryConf.forEach(handleAddRow2);
        buttonConf.forEach(handleAddRow3);
    })

    function getFormData(id, num) {
        let res = [];
        for (let i = 0; i < num; ++i) {
            res.push(serToJson(new FormData(document.getElementById(`${id}${i}`))));
        }
        return res;
    }

    function saveData() {
        let fieldConf = getFormData("fieldForm", formId1);
        let queryConf = getFormData("queryForm", formId2);
        let buttonConf = getFormData("btnForm", formId3);
        let parentForm = serToJson(new FormData(document.getElementById(`parentForm`)));
        let data = {
            ...parentForm,
            buttonConf: JSON.stringify(buttonConf),
            fieldConf: JSON.stringify(fieldConf),
            queryConf: JSON.stringify(queryConf)
        }
        $.ajax({
            type: "POST",
            url: "/system/menu/save-or-update",
            dataType: 'json',
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (res) {
                if (res.code === 200) {
                    let index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                }
            },
            error: function () {

            }
        });
    }

    /**
     * 列表配置
     * @param info
     */
    function handleAddRow1(info) {
        let $fieldContent = $("#content1");
        let tmItem = document.createElement('div');
        tmItem.innerHTML = `<form id="fieldForm${formId1}">
                                            <div class="tab-tr" style="width: 140px">
                                                <input type="number" name="fieldLocal" class="layui-input" placeholder="请输入显示位置" min="0" value="${info ? info.fieldLocal : ''}">
                                            </div>
                                            <div class="tab-tr" style="width: 140px">
                                                <input type="text" name="fieldName" class="layui-input" placeholder="请输入字段" value="${info ? info.fieldName : ''}">
                                            </div>
                                             <div class="tab-tr" style="width: 140px">
                                                <input type="text" name="fieldLabel" class="layui-input" placeholder="请输入字段名称" value="${info ? info.fieldLabel : ''}">
                                            </div>
                                            <div class="tab-tr" style="width: 140px">
                                                <input type="text"  name="fieldDesc" class="layui-input" placeholder="请输入字段备注"  value="${info ? info.fieldDesc : ''}">
                                            </div>
                                            <div class="tab-tr" style="width: 100px">
                                             <i style="line-height: 38px;font-size: 24px;" class="layui-icon layui-icon-delete" onclick="handleRemoveRow(this,'#content1')"></i>
                                            </div>
                             </form>`;
        tmItem.classList.add('tab-row');
        $fieldContent.append(tmItem);
        formId1++;
    }

    /**
     * 查询配置
     * @param info
     */
    function handleAddRow2(info) {
        let $fieldContent = $("#content2");
        let tmItem = document.createElement('div');
        tmItem.innerHTML = ` <form id="queryForm${formId2}">
                                        <div class="tab-tr" style="width: 140px">
                                            <input type="text" name="fieldName" class="layui-input" placeholder="请输入字段名称" value="${info ? info.fieldName : ''}">
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <input type="text" name="queryDesc" class="layui-input" placeholder="请输入查询描述" value="${info ? info.queryDesc : ''}">
                                        </div>
                                        <div class="tab-tr" style="width: 140px">
                                            <input type="text" name="queryInputType" class="layui-input" placeholder="请选择控件类型" value="${info ? info.queryInputType : ''}">
                                        </div>
                                        <div class="tab-tr" style="width: 100px">
                                            <input type="text" name="dictCode"  class="layui-input" value="${info ? info.dictCode : ''}">
                                        </div>
                                        <div class="tab-tr" style="width: 100px">
                                            <input type="text" name="defaultVal" class="layui-input" value="${info ? info.defaultVal : ''}">
                                        </div>
                                         <div class="tab-tr" style="width: 100px">
                                             <i style="line-height: 38px;font-size: 24px;" class="layui-icon layui-icon-delete" onclick="handleRemoveRow(this,'#content2')"></i>
                                        </div>
                              </form>`;
        tmItem.classList.add('tab-row');
        $fieldContent.append(tmItem);
        formId2++;
    }

    /**
     * 按钮配置
     * @param info
     */
    function handleAddRow3(info) {
        layui.use(function () {
            let $fieldContent = $("#content3")[0];
            let tmItem = document.createElement('div');
            tmItem.innerHTML = `<form id="btnForm${formId3}">
                                            <div class="tab-tr" style="width: 140px">
                                                <input type="text" name="btnName" class="layui-input" placeholder="请输入按钮名称" value="${info ? info.btnName : ''}">
                                            </div>

                                            <div class="tab-tr" style="width: 140px">
                                                <input type="text" name="btnUrl" class="layui-input" placeholder="请输入URL" value="${info ? info.btnUrl : ''}">
                                            </div>

                                            <div class="tab-tr" style="width: 140px">
                                             <select class="layui-input" lay-filter="demo-select-filter" name="queryType">
                                               <option value="1" ${info && info.queryType === '1' ? 'selected' : ''}>表格工具栏</option>
                                               <option value="2" ${info && info.queryType === '2' ? 'selected' : ''}>明细工具栏</option>
                                              </select>
                                            </div>
                                            <div class="tab-tr" style="width: 140px">
                                                <input type="text" name="fieldName" class="layui-input" placeholder="请输入参数字段" value="${info ? info.fieldName : ''}">
                                            </div>

                                            <div class="tab-tr" style="width: 140px">
                                                <input type="text" name="btnIcon" style="width: 110px" class="layui-input" id="btn${formId3}"
                                                       placeholder="图标" value="${info ? info.btnIcon : ''}">
                                                <i id="ico-btn" class="layui-icon layui-icon-search" onclick="openIconsHtml('btn${formId3}')"
                                                   style="cursor: pointer; margin: 13px 0 0 5px"></i>
                                            </div>
                                            <div class="tab-tr" style="width: 140px">
                                                <input type="text" name="btnHint" class="layui-input" placeholder="请输入提示信息" value="${info ? info.btnHint : ''}">
                                            </div>
                                            <div class="tab-tr" style="width: 140px">
                                                <div class="layui-form" style="margin-left: 5px">
                                                    <input type="radio" name="btnAuth" th:value="0" title="是" checked>
                                                    <input type="radio" name="btnAuth" th:value="1" title="否">
                                                </div>
                                            </div>
                                            <div class="tab-tr" style="width: 100px">
                                             <i style="line-height: 38px;font-size: 24px;" class="layui-icon layui-icon-delete" onclick="handleRemoveRow(this,'#content3')"></i>
                                            </div>
                                        </form>`;
            tmItem.classList.add('tab-row');
            $fieldContent.append(tmItem);
            formId3++;
            layui.form.render('radio');
        });
    }

    /**
     * 移除行
     * @param item
     * @param id
     */
    function handleRemoveRow(item, id) {
        let tm = item.parentElement.parentElement.parentElement;
        let $fieldContent = $(id)[0];
        $fieldContent.removeChild(tm);
        if (id === '#content1') {
            formId1--;
        } else if (id === '#content2') {
            formId2--;
        } else if (id === '#content3') {
            formId3--;
        }
    }

</script>
</body>

</html>